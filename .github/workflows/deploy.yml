name: Deploy to nymeta.in

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # (Optional) Quick port probe
      - name: Probe SSH port
        env:
          THE_HOST: ${{ secrets.SSH_HOST }}
          THE_PORT: ${{ secrets.SSH_PORT || '22' }}
        run: |
          echo "Testing TCP to ${THE_HOST}:${THE_PORT}"
          timeout 10 bash -c "cat < /dev/null > /dev/tcp/${THE_HOST}/${THE_PORT}" \
            && echo "Port open ✅" || (echo "Port closed ❌" && exit 1)

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}      # <— use SSH_USER secret
          key: ${{ secrets.SSH_KEY }}            # <— PRIVATE key
          port: ${{ secrets.SSH_PORT || '22' }}
          command_timeout: 15m
          script_stop: true
          script: |
            set -e

            echo "➡️  Pull latest code"
            cd /var/www/nypay
            git fetch --all
            git reset --hard origin/main

            echo "➡️  Build frontend (npm)"
            npm ci
            npm run build

            echo "➡️  Publish static site to /var/www/nypay_site"
            mkdir -p /var/www/nypay_site
            rsync -a --delete /var/www/nypay/dist/ /var/www/nypay_site/
            chown -R www-data:www-data /var/www/nypay_site

            echo "➡️  Install backend deps"
            cd /var/www/nypay/backend
            npm ci

            echo "➡️  Ensure uploads folders"
            mkdir -p /var/www/nypay/backend/uploads/{slider,panels,profile_pic}

            echo "➡️  Reload backend via PM2"
            pm2 describe nypay-backend >/dev/null 2>&1 && \
              pm2 restart nypay-backend --update-env || \
              pm2 start /var/www/nypay/backend/server.js --name nypay-backend --update-env

            pm2 save

            echo "➡️  Reload Nginx"
            nginx -t && systemctl reload nginx

            echo "✅ Deploy done"
