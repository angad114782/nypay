name: Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # (Optional) Port probe: SSH port khula hai ya nahi
      - name: Probe SSH port
        run: |
          echo "Testing TCP to ${{ secrets.SSH_HOST }}:${{ secrets.SSH_PORT || 22 }}"
          timeout 10 bash -c "cat < /dev/null > /dev/tcp/${{ secrets.SSH_HOST }}/${{ secrets.SSH_PORT || 22 }}" \
            && echo "Port open ✅" || (echo "Port closed ❌" && exit 1)

      # Actual deploy via SSH
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}            # e.g. 203.0.113.10
          username: ${{ secrets.SSH_USERNAME }}    # e.g. ubuntu
          key: ${{ secrets.SSH_KEY }}              # PRIVATE key (PEM)
          port: ${{ secrets.SSH_PORT || 22 }}      # custom ho to secret me set karo
          timeout: "60s"
          command_timeout: "10m"
          script_stop: true
          script: |
            set -e

            # Node/pnpm ensure (agar server par pnpm nahi to)
            if ! command -v pnpm >/dev/null 2>&1; then
              if command -v corepack >/dev/null 2>&1; then
                corepack enable
                corepack prepare pnpm@latest --activate
              else
                npm i -g pnpm
              fi
            fi

            # Project path (APNE SERVER KA PATH RAKHO)
            cd /var/www/nypay

            # Git pull
            git fetch --all
            git reset --hard origin/main

            # Install & build
            pnpm install --frozen-lockfile
            pnpm build

            # PM2 reload (process name ya ecosystem file ke hisaab se)
            if pm2 list | grep -q "nypay"; then
              pm2 reload nypay
            elif [ -f ecosystem.config.js ]; then
              pm2 startOrReload ecosystem.config.js
            else
              # First time start (example)
              pm2 start "pnpm start" --name nypay
            fi

            pm2 save
